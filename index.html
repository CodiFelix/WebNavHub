<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CodiFelix NavHub å¯¼èˆªä¸»é¡µ</title>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <style>
        :root { 
            --accent: #8ab4f8; 
            --bg-glass: rgba(255,255,255,0.12);
            --icon-shadow: 0 6px 14px rgba(0,0,0,0.45);
            --icon-shadow-hover: 0 6px 14px rgba(0,0,0,0.45);
            --text-color: #fff;
        }
        body {
            margin: 0; padding: 0; font-family: "Segoe UI", sans-serif;
            background: #202124 url('image0.webp') no-repeat center center fixed;
            background-size: cover;
            color: #fff; display: flex; flex-direction: column; align-items: center;
            min-height: 100vh; transition: 0.3s; overflow-y: auto;
        }
        .top-bar { position: fixed; top: 20px; right: 20px; display: flex; gap: 10px; z-index: 100; }
        button, .btn-label {
            background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2);
            color: white; padding: 6px 12px; border-radius: 8px; cursor: pointer; backdrop-filter: blur(10px); font-size: 13px;
        }
        .search-area { 
                      margin-top: 3vh;
                      width: 90%; 
                      max-width: 720px;
                      text-align: center; 
                    }
        #logo { 
            font-size: 70px; 
            font-weight: bold; 
            margin-bottom: 35px;
            letter-spacing: -3px;
        }
        .input-group {
            display: flex; background: white; border-radius: 30px; padding: 5px 15px;
            align-items: center; box-shadow: 0 4px 25px rgba(0,0,0,0.5);
        }
        select { border: none; background: none; font-weight: bold; padding: 10px; color: #444; outline: none; cursor: pointer; }
        #search-input { flex: 1; border: none; outline: none; padding: 12px; font-size: 16px; color: #000; }
        .container { width: 95%; max-width: 1100px; margin-top: 40px; padding-bottom: 50px; }
        .grid { 
            display: grid; 
            grid-template-columns: repeat(8, 1fr); 
            gap: 12px; 
            margin-bottom: 40px; 
            perspective: none;
        }
        @media (max-width: 950px) {
            #memo-container {
                margin-top: 150px !important; 
                transition: 0.3s;
                }
            .grid { grid-template-columns: repeat(4, 1fr); }
        }
        @media (max-width: 730px) {
            .top-bar { 
                 position: relative !important; 
                 top: 0 !important; 
                 right: 0 !important; 
                 padding: 10px; 
                 justify-content: center; 
                 flex-wrap: wrap; 
                 background: rgba(0,0,0,0.2); 
                 margin-bottom: 10px;
                }
             .welcome-box { 
                 position: relative !important; 
                 top: 0 !important; 
                 left: 0 !important; 
                 margin: 10px 0 10px 20px !important; 
                }
            #memo-container {
                margin-top: 10px !important; 
                }
            #memo-input {
                min-height: 90px !important;
                max-height: 200px !important;
                }
            .search-area {
                width: 95% !important; 
                margin: 20px auto !important; 
                }
            .input-group {
                width: 100% !important;
                box-sizing: border-box;
                padding: 10px 15px !important; 
                }
            #search-input {
                width: 10px;
                font-size: 16px !important; 
                padding: 10px !important; 
                font-weight: 500 !important;
                }
            select {
                padding: 5px 2px 5px 8px !important;
                font-size: 13px !important;
                max-width: 95px !important;
                min-width: 75px !important;
                background-position: right 2px center;
                }
            #logo { 
                font-size: 45px !important;
                margin-bottom: 25px !important;
                line-height: 1.2 !important;
                height: auto !important;
                display: block !important;
                }
            .grid { 
                grid-template-columns: repeat(3, 1fr); 
                gap: 8px; 
                }
            #memo-input {
                background: rgba(255, 255, 255, 0.1) !important; 
                border: 1px solid rgba(255, 255, 255, 0.1) !important;
                }
            .grid a {
                display: flex !important;
                flex-direction: column;
                align-items: center;
                width: 100%;
                text-decoration: none;
                -webkit-tap-highlight-color: rgba(0,0,0,0);
                }
            .card {
                -webkit-touch-callout: none !important; 
                -webkit-user-select: none !important;
                user-select: none !important;
                touch-action: pan-y !important; 
                -webkit-user-drag: none !important;
                }
            .edit-mode .card {
                border: 1px dashed rgba(255,255,255,0.3);
                border-radius: 8px;
                cursor: move !important;
                touch-action: none !important;
                }
            .signature-fixed { display: none; } 
        }
        .grid img {
            -webkit-user-drag: none !important;
            pointer-events: none !important;
            }
        .sortable-ghost {
            opacity: 0.4;
            background: var(--accent) !important;
            }
        @media (hover: none) and (pointer: coarse) {
            .grid > a {
                transition: none;
            }
            .grid > a:active {
                transform: none;
                filter: none;
            }
            .grid > a:active .icon-circle {
                transform: none;
                box-shadow: var(--icon-shadow);
            }
        }
        .card { 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            position: relative; 
            text-decoration: none; 
            color: white; 
            cursor: default;
            width: 100%;
            height: 120px; 
            justify-content: center;
            transform-style: flat;
            transition: none;
        }
        .icon-circle { 
            width: 48px; 
            height: 48px; 
            border-radius: 50%;
            background: var(--bg-glass);
            backdrop-filter: blur(6px);
            display: flex; 
            align-items: center; 
            justify-content: center; 
            margin-bottom: 8px; 
            overflow: hidden; 
            pointer-events: auto !important;
            cursor: pointer !important;
            transform: none;
            box-shadow: var(--icon-shadow);
            transition: background 0.2s ease;
        }
        .icon-circle:hover {
            background: rgba(255,255,255,0.18) !important;
        }
        .icon-circle img { width: 24px; height: 24px; }
        .edit-btns { position: absolute; top: -8px; right: 8px; display: none; z-index: 10; gap: 3px; }
        .edit-mode .edit-btns { display: flex; }
        .btn-sm { width: 20px; height: 20px; border-radius: 50%; border: none; color: white; font-size: 10px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .btn-del { background: #ff4d4d; }
        .btn-edit { background: #fbbc05; color: #000; }
        .btn-pin { background: #34a853; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; align-items: center; justify-content: center; }
        .modal-content { background: #2d2e31; padding: 25px; border-radius: 15px; width: 340px; border: 1px solid #444; }
        .modal-content input { width: 100%; padding: 12px; margin: 10px 0; border-radius: 8px; border: 1px solid #444; background: #1a1a1a; color: white; box-sizing: border-box; }
        .hidden { display: none; }
        .signature-fixed {
            position: fixed;
            top: 65px;
            right: 20px;
            z-index: 99;
            font-size: 12px;
            color: rgba(255,255,255,0.6);
            font-style: italic;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
            }
        .welcome-box {
            position: fixed;
            top: 20px;
            left: 25px;
            z-index: 100;
            display: flex;
            flex-direction: column;
            gap: 6px;
            }
        #auto-device-info {
            white-space: pre-line;
            line-height: 1.5;
            font-size: 11px;
            color: #4a90e2;
            font-family: "Consolas", monospace;
            opacity: 1;
            letter-spacing: 0.2px;
            }
        #copy-btn:hover, #clear-btn:hover {
            color: #8ab4f8 !important;
            opacity: 1;
        }
        #pub-ip {
            font-size: 11px;
            color: rgba(255,255,255,0.4);
            font-family: "Consolas", monospace;
            line-height: 1.5;
            }
        #search-history-area {
            margin-top: 30px;
            }
        #history-list {
            display: flex;
            flex-wrap: wrap;
            justify-content: flex-start;
            gap: 10px 20px;
            max-height: 450px;
            overflow-y: auto;
            padding: 10px;
            }
        #history-list::-webkit-scrollbar {
            width: 6px;
            }
        #history-list::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 10px;
            }
        .history-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: auto; 
            min-width: 90px; 
            margin: 0 15px 15px 15px; 
            flex-shrink: 0;
            }
        .history-click-zone {
            cursor: pointer !important;
            user-select: none;
            }
        .history-icon-circle {
            width: 42px;
            height: 42px;
            background: rgba(255, 255, 255, 0.08);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 8px;
            transition: none;
            }
        .history-click-zone:hover .history-icon-circle {
            background: rgba(255, 255, 255, 0.08);
            }
        .history-text-selectable {
            font-size: 13px;
            color: rgba(255,255,255,0.8);
            text-align: center;
            width: 100%;
            display: block;
            margin-top: 10px;
            white-space: normal;
            word-break: break-all;
            cursor: text;
            user-select: text;
        }
        .grid > .card:hover {
            transform: none;
            filter: none;
        }
        .edit-mode .grid > .card:hover {
            transform: none !important;
            filter: none !important;
        }
        .grid > .card:hover .icon-circle {
            transform: none;
            box-shadow: var(--icon-shadow);
        }
        /* ä¸»é¢˜æ¨¡å¼ */
        body.dark {
            --bg-glass: rgba(255,255,255,0.12);
            --icon-shadow: 0 6px 14px rgba(0,0,0,0.45);
            --icon-shadow-hover: 0 6px 14px rgba(0,0,0,0.45);
            --text-color: #fff;
        }
        body.light {
            --bg-glass: rgba(255,255,255,0.65);
            --icon-shadow: 0 6px 14px rgba(0,0,0,0.18);
            --icon-shadow-hover: 0 6px 14px rgba(0,0,0,0.18);
            --text-color: #111;
        }
        .grid > .card {
            color: var(--text-color);
        }
        /* ç¼–è¾‘æ¨¡å¼å¼ºåˆ¶ç¦ç”¨å‘¼å¸åŠ¨ç”» */
        .edit-mode .icon-circle {
            animation: none !important;
            filter: none !important;
        }
        /* å¡ç‰‡å†…å®¹åŒºåŸŸæ ·å¼ */
        .card-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            cursor: default;
            padding: 0 4px;
        }
        /* ä¿®å¤æ¨¡æ€æ¡†æŒ‰é’®å¯ç‚¹å‡»æ€§ */
        .modal-content button {
            pointer-events: auto !important;
            z-index: 1001 !important;
        }
        /* æ–‡å­—åŒºåŸŸåŸºç¡€æ ·å¼ */
        .site-name-text {
            font-size: 12px;
            line-height: 1.4;
            height: 40px;
            text-align: center;
            overflow: hidden;
            padding: 0 2px;
            width: 100%;
            box-sizing: border-box;
            display: block;
        }
    </style>
</head>
<body>
<div class="welcome-box">
        <!-- è¿”å›é¦–é¡µæŒ‰é’® -->
    <a href="https://www.firegle.com" style="display: inline-block">
        è¿”å›é¦–é¡µ
    </a>
    <div style="font-size: 24px; font-weight: bold; color: white; margin-bottom: 5px;">Hi, CodiFelix HavHub</div>
    <div id="auto-device-info">
        SYST: è·å–ä¸­...
    </div>
    <div id="pub-ip">
        IP: æ­£åœ¨è·å–...
    </div>
</div>

<div class="signature-fixed" style="font-size: 14px; opacity: 0.8;">â€œ ç”Ÿæ´»æ˜æœ—ï¼Œä¸‡ç‰©å¯çˆ± â€</div>
<div id="memo-container" style="margin: 40px auto 0; width: 95%; max-width: 600px;">
    <div style="display: flex; align-items: center; margin-bottom: 8px;">
        <span style="font-size: 14px; color: #8ab4f8; font-weight: bold; opacity: 0.8; white-space: nowrap;">ğŸ“ å¤‡å¿˜å½•</span>
        <span id="save-status" style="font-size: 12px; opacity: 0; transition: 0.3s; color: #34a853; margin-left: 10px; white-space: nowrap;">å·²å­˜å…¥</span>
    </div>
    <textarea id="memo-input" placeholder="ç‚¹å‡»è¿™é‡Œå¼€å§‹è®°å½•...  å†…å®¹ä¼šè‡ªåŠ¨ä¿å­˜.. æˆ– ç‚¹å‡»å‘é€åˆ°é‚®ç®±..&#10;æ³¨æ„ä»¥ä¸‹å‡ ç‚¹ä¼šå¯¼è‡´å†…å®¹æ¶ˆå¤±ï¼š&#10;æ¸…ç†æµè§ˆå™¨ç¼“å­˜; å¤šæ ‡ç­¾é¡µä¼šå¯¼è‡´å†…å®¹è¢«è¦†ç›–&#10;ç³»ç»Ÿç£ç›˜æ¸…ç†; æµè§ˆå™¨å‡çº§/é‡è£…"
        style="width: 100%; min-height: 90px; max-height: 200px; background: rgba(255,255,255,0.1) !important; border: 1px solid rgba(255,255,255,0.1) !important; border-radius: 12px; color: #fff; padding: 15px; outline: none; resize: none; font-size: 14px; line-height: 1.6; overflow-y: auto;"></textarea>
    <div style="display: flex; justify-content: flex-end; gap: 12px; margin-top: 0px; padding-right: 0px; font-size: 11px; color: rgba(255,255,255,0.3);">
        <span id="resend-btn" style="cursor: pointer; display: flex; align-items: center; gap: 3px; transition: 0.2s;">âœ‰ï¸ å‘é€åˆ°é‚®ç®±</span>
        <span id="copy-btn" style="cursor: pointer; display: flex; align-items: center; gap: 3px; transition: 0.2s;">ğŸ“‹ å¤åˆ¶</span>
        <span id="clear-btn" style="cursor: pointer; display: flex; align-items: center; gap: 3px; transition: 0.2s;">ğŸ—‘ï¸ æ¸…ç©º</span>
    </div>
</div>

<div class="top-bar">
    <button onclick="openSiteModal()">+ æ·»åŠ ç«™ç‚¹</button>
    <button onclick="openModal('bg-modal')">ğŸ–¼ï¸ èƒŒæ™¯</button>
    <button onclick="exportData()">ğŸ’¾ å¤‡ä»½</button>
    <button onclick="document.getElementById('import-file').click()">ğŸ“‚ æ¢å¤</button>
    <input type="file" id="import-file" class="hidden" onchange="importData(event)">
    <button onclick="toggleEdit()" id="edit-toggle-btn">âš™ï¸ ç®¡ç†</button>
</div>
<div id="site-modal" class="modal">
    <div class="modal-content">
        <h3 id="modal-title">å¿«æ·æ–¹å¼</h3>
        <input type="hidden" id="edit-id">
        <input type="text" id="site-name" placeholder="åç§°">
        <input type="text" id="site-url" placeholder="ç½‘å€">
        <input type="text" id="site-icon" placeholder="å›¾æ ‡URL (å¯é€‰)">
        <input type="text" id="site-remark" placeholder="å¤‡æ³¨ï¼ˆé¼ æ ‡æ‚¬åœæ˜¾ç¤ºï¼Œå¯é€‰ï¼‰">
        <div style="text-align:right; margin-top: 20px;">
            <button onclick="closeModal('site-modal')" style="padding: 8px 20px; margin-right: 10px; background: rgba(255,255,255,0.1); color: #fff; border: 1px solid rgba(255,255,255,0.2); border-radius: 5px; cursor: pointer;">å–æ¶ˆ</button>
            <button onclick="saveSite()" style="background:var(--accent); color:#000; padding:8px 20px; border-radius:5px; font-weight:bold; cursor: pointer;">ç¡®å®š</button>
        </div>
    </div>
</div>
<div id="bg-modal" class="modal">
    <div class="modal-content">
        <h3>èƒŒæ™¯è®¾ç½®</h3>
        <label class="btn-label" style="display:block; text-align:center; margin-bottom:15px;">ğŸ“ æœ¬åœ°ä¸Šä¼ <input type="file" id="bg-file" class="hidden" onchange="uploadLocalBg()"></label>
        <input type="text" id="bg-url-input" placeholder="ç½‘ç»œå›¾ç‰‡URL (å›è½¦)" onkeypress="if(event.keyCode==13) setNetBg()">
        <input type="color" id="bg-color-pick" style="width:100%; height:40px;" onchange="setSolidBg()">
        <button onclick="resetBg()" style="width:100%; margin-top:10px; background:rgba(255,255,255,0.1); color:#fff; border:1px solid rgba(255,255,255,0.2); padding:8px; border-radius:5px;">â™»ï¸ æ¢å¤é»˜è®¤èƒŒæ™¯</button>
        <div style="text-align:right; margin-top:15px;">
            <button onclick="closeModal('bg-modal')" style="background:none; border:none; color:#fff;">å…³é—­</button>
        </div>
    </div>
</div>
<div class="search-area">
    <div id="logo">Google</div>
    <div class="input-group">
        <select id="engine" onchange="updateUI()" style="font-size: 16px;">
            <option value="google">ğŸ¥³ <span style="font-size: 14px;">Google</span></option>
            <option value="bing">ğŸ¸ <span style="font-size: 14px;">Bing</span></option>
            <option value="baidu">ğŸ¾ <span style="font-size: 14px;">Baidu</span></option>
        </select>
        <input type="text" id="search-input" placeholder="å›è½¦æœç´¢ ( Alt + S é”®åˆ‡æ¢æœç´¢å¼•æ“ )" autofocus onkeypress="if(event.keyCode==13) doSearch()">
    </div>
</div>
<div class="container">
    <h4 style="border-left:4px solid var(--accent); padding-left:10px; margin-bottom:20px;">å¿«æ·å¯¼èˆª</h4>
    <div class="grid" id="site-list"></div>

    <div id="search-history-area" style="display:none; margin-top: 30px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding: 0 5px;">
            <h4 style="border-left:4px solid #ffcc00; padding-left:10px; margin:0;">æœ€è¿‘æœç´¢</h4>
            <a href="javascript:void(0);" onclick="clearHistory()" style="font-size: 13px; color: #ff4d4d; text-decoration: none; cursor: pointer !important;">æ¸…ç©ºå…¨éƒ¨</a>
        </div>
        <div class="grid" id="history-list"></div>
    </div>
</div>

<script>
    // å…¨å±€å¸¸é‡å®šä¹‰
    const engines = {
        google: { 
            url: "https://www.google.com/search?q=", 
            color: "#4285f4", 
            name: "Google",
            logoIcon: "google-brand-color.webp"
        },
        bing: { 
            url: "https://www.bing.com/search?q=",
            color: "#00809d", 
            name: "Bing",
            logoIcon: "BingOct2020logo.svg"
        },
        baidu: { 
            url: "https://www.baidu.com/s?wd=",
            color: "#ff2d46", 
            name: "Baidu",
            logoIcon: "baidu-brand-color.webp"
        }
    };
    const engineKeys = ['google', 'bing', 'baidu'];
    const STORAGE_KEY = 'cfg_vfinal_memo';
    const USAGE_KEY = 'nav_usage_map';
    
    // ========== å·¥å…·å‡½æ•°ï¼šæˆªæ–­æ–‡å­—ä¸º2è¡Œ ==========
    function truncateText(text, maxLines = 1, maxLengthPerLine = 16) {
        const maxTotalLength = maxLines * maxLengthPerLine;
        if (text.length <= maxTotalLength) return text;
        
        // æˆªæ–­åæ·»åŠ çœç•¥å·
        return text.slice(0, maxTotalLength) + '...';
    }
    
    // ========== ä½¿ç”¨é¢‘ç‡ç»Ÿè®¡æ ¸å¿ƒé€»è¾‘ ==========
    let usageMap = JSON.parse(localStorage.getItem(USAGE_KEY) || '{}');

    // ä¿å­˜ä½¿ç”¨ç»Ÿè®¡åˆ°æœ¬åœ°å­˜å‚¨
    function saveUsage() {
        localStorage.setItem(USAGE_KEY, JSON.stringify(usageMap));
    }

    // ç§»é™¤å‘¼å¸é«˜äº®æ•ˆæœå‡½æ•°ï¼ˆä¸å†éœ€è¦ï¼‰
    function applyUsageHighlight() {
        return;
    }

    // ç»‘å®šç‚¹å‡»äº‹ä»¶ç»Ÿè®¡ä½¿ç”¨æ¬¡æ•°ï¼ˆåªç»‘å®šå›¾æ ‡ï¼‰
    function bindUsageClickEvent() {
        document.querySelectorAll('#site-list .icon-circle').forEach(icon => {
            const card = icon.closest('.card');
            if (!card) return;
            
            const id = card.getAttribute('data-id');
            const sites = JSON.parse(localStorage.getItem('cfg_vfinal_sites')) || [];
            const site = sites.find(s => s.id == id);
            
            if (site && site.url) {
                icon.addEventListener('click', () => {
                    usageMap[site.url] = (usageMap[site.url] || 0) + 1;
                    saveUsage();
                });
            }
        });
    }

    // ========== æ ¸å¿ƒåŠŸèƒ½å‡½æ•° ==========
    function setEngine(v) { 
        document.getElementById('engine').value = v; 
        updateUI(); 
    }

    // æ‰“å¼€æ¨¡æ€æ¡†ï¼ˆä¿®å¤ï¼šé‡å†™äº‹ä»¶ç»‘å®šé€»è¾‘ï¼‰
    function openModal(id) {
        const modal = document.getElementById(id);
        if (!modal) return;
        
        modal.style.display = 'flex';
        modal.onclick = null;
        
        modal.addEventListener('click', function(e) {
            if (e.target === modal) {
                closeModal(id);
            }
        }, { once: true });
    }

    // å…³é—­æ¨¡æ€æ¡†
    function closeModal(id) {
        const modal = document.getElementById(id);
        if (!modal) {
            console.error('æ¨¡æ€æ¡†ä¸å­˜åœ¨ï¼š', id);
            return;
        }
        modal.style.display = 'none';
        
        if (id === 'site-modal') {
            const editIdInput = document.getElementById('edit-id');
            const siteName = document.getElementById('site-name');
            const siteUrl = document.getElementById('site-url');
            const siteIcon = document.getElementById('site-icon');
            const siteRemark = document.getElementById('site-remark');
            
            if (editIdInput) editIdInput.value = '';
            if (siteName) siteName.value = '';
            if (siteUrl) siteUrl.value = '';
            if (siteIcon) siteIcon.value = '';
            if (siteRemark) siteRemark.value = '';
        }
    }

    function uploadLocalBg() {
        const file = document.getElementById('bg-file').files[0];
        const reader = new FileReader();
        reader.onloadend = () => applyBg(reader.result, 'img');
        if(file) reader.readAsDataURL(file);
    }

    function setNetBg() { 
        applyBg(document.getElementById('bg-url-input').value, 'img'); 
    }

    function setSolidBg() { 
        applyBg(document.getElementById('bg-color-pick').value, 'color'); 
    }

    function doSearch() {
        const type = document.getElementById('engine').value;
        const inputEl = document.getElementById('search-input');
        const kw = inputEl.value.trim();
        if(!kw) return;
        
        let hist = JSON.parse(localStorage.getItem('cfg_vfinal_hist')) || [];
        hist = hist.filter(item => item.name !== kw);
        hist.unshift({ 
            id: Date.now(), 
            name: kw, 
            url: engines[type].url + encodeURIComponent(kw) 
        });
        localStorage.setItem('cfg_vfinal_hist', JSON.stringify(hist.slice(0, 100)));
        renderHistory();
        
        const targetUrl = engines[type].url + encodeURIComponent(kw);
        const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
        if (isMobile) {
            window.location.href = targetUrl;
        } else {
            window.open(targetUrl, '_blank');
        }
    }

    function saveSearch(kw) {
        let hist = JSON.parse(localStorage.getItem('cfg_vfinal_hist')) || [];
        hist = hist.filter(item => item.name !== kw);
        hist.unshift({ id: Date.now(), name: kw });
        localStorage.setItem('cfg_vfinal_hist', JSON.stringify(hist.slice(0, 100)));
    }

    // æ‰“å¼€ç«™ç‚¹ç¼–è¾‘æ¨¡æ€æ¡†
    function openSiteModal(id = null) {
        const sites = JSON.parse(localStorage.getItem('cfg_vfinal_sites')) || [];
        const editIdInput = document.getElementById('edit-id');
        const siteName = document.getElementById('site-name');
        const siteUrl = document.getElementById('site-url');
        const siteIcon = document.getElementById('site-icon');
        const siteRemark = document.getElementById('site-remark');
        const modalTitle = document.getElementById('modal-title');

        if (!editIdInput || !siteName || !siteUrl || !modalTitle) {
            console.error('æ¨¡æ€æ¡†è¡¨å•å…ƒç´ ç¼ºå¤±');
            return;
        }

        if (!id) {
            editIdInput.value = "";
            siteName.value = "";
            siteUrl.value = "";
            siteIcon.value = "";
            siteRemark.value = "";
            modalTitle.textContent = "æ·»åŠ å¿«æ·æ–¹å¼";
        } else {
            const site = sites.find(s => s.id == id);
            if (site) {
                editIdInput.value = id;
                siteName.value = site.name || "";
                siteUrl.value = site.url || "";
                siteIcon.value = site.icon || "";
                siteRemark.value = site.remark || "";
                modalTitle.textContent = "ç¼–è¾‘å¿«æ·æ–¹å¼";
            } else {
                alert('æœªæ‰¾åˆ°è¯¥ç«™ç‚¹ï¼Œå¯èƒ½å·²è¢«åˆ é™¤');
                closeModal('site-modal');
                return;
            }
        }
        openModal('site-modal');
    }

    // ä¿å­˜ç«™ç‚¹
    function saveSite() {
        const editIdInput = document.getElementById('edit-id');
        const siteName = document.getElementById('site-name');
        const siteUrl = document.getElementById('site-url');
        const siteIcon = document.getElementById('site-icon');
        const siteRemark = document.getElementById('site-remark');

        if (!editIdInput || !siteName || !siteUrl) {
            alert('è¡¨å•å…ƒç´ åŠ è½½å¼‚å¸¸ï¼Œè¯·åˆ·æ–°é¡µé¢');
            return;
        }
        const name = siteName.value.trim();
        let url = siteUrl.value.trim();
        if (!name) {
            alert('è¯·è¾“å…¥ç«™ç‚¹åç§°');
            siteName.focus();
            return;
        }
        if (!url) {
            alert('è¯·è¾“å…¥ç«™ç‚¹ç½‘å€');
            siteUrl.focus();
            return;
        }

        if (!/^https?:\/\//i.test(url)) {
            url = 'https://' + url;
        }

        let sites = [];
        try {
            sites = JSON.parse(localStorage.getItem('cfg_vfinal_sites') || '[]');
        } catch (e) {
            console.error('æœ¬åœ°ç«™ç‚¹æ•°æ®æŸåï¼Œå·²é‡ç½®', e);
            localStorage.setItem('cfg_vfinal_sites', '[]');
        }

        const editId = editIdInput.value;
        const siteData = {
            id: editId ? parseInt(editId) : Date.now(),
            name: name,
            url: url,
            icon: siteIcon.value.trim(),
            remark: siteRemark.value.trim()
        };

        if (!editId) {
            sites.push(siteData);
        } else {
            const idx = sites.findIndex(s => s.id == editId);
            if (idx !== -1) {
                sites[idx] = siteData;
            } else {
                alert('æœªæ‰¾åˆ°è¯¥ç«™ç‚¹ï¼Œå·²æ–°å¢ä¸ºæ–°ç«™ç‚¹');
                sites.push(siteData);
            }
        }

        localStorage.setItem('cfg_vfinal_sites', JSON.stringify(sites));
        render();
        closeModal('site-modal');
    }

    function removeData(key, id) {
        let data = JSON.parse(localStorage.getItem(key)) || [];
        const filtered = data.filter(item => item.id != id);
        localStorage.setItem(key, JSON.stringify(filtered));
        render();
    }

    function pinHistory(id) {
        let hist = JSON.parse(localStorage.getItem('cfg_vfinal_hist')) || [];
        let sites = JSON.parse(localStorage.getItem('cfg_vfinal_sites')) || [];
        const item = hist.find(h => h.id == id);
        
        if(item) { 
            sites.push({ ...item, id: Date.now() }); 
            localStorage.setItem('cfg_vfinal_sites', JSON.stringify(sites)); 
            removeData('cfg_vfinal_hist', id); 
        }
    }

    function initSortable() {
        const el = document.getElementById('site-list');
        if (!el) return;
        
        const isEditMode = document.body.classList.contains('edit-mode');
        const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
        
        if (window.sortableInstance) {
            window.sortableInstance.destroy();
        }
        
        window.sortableInstance = Sortable.create(el, {
            animation: 0,
            disabled: isMobile ? !isEditMode : false, 
            delay: isMobile ? 200 : 100,
            delayOnTouchOnly: true,
            touchStartThreshold: 20,
            onEnd: function() {
                let newOrder = []; 
                const sites = JSON.parse(localStorage.getItem('cfg_vfinal_sites')) || [];
                
                document.querySelectorAll('#site-list .card').forEach(card => {
                    const id = card.getAttribute('data-id');
                    const site = sites.find(s => s.id == id);
                    if(site) newOrder.push(site);
                });
                
                localStorage.setItem('cfg_vfinal_sites', JSON.stringify(newOrder));
            }
        });
    }

    function resetBg() {
        if(confirm("ç¡®å®šè¦åˆ é™¤è‡ªå®šä¹‰èƒŒæ™¯ï¼Œæ¢å¤åˆ°é»˜è®¤èƒŒæ™¯å—ï¼Ÿ")) {
            localStorage.removeItem('cfg_vfinal_bg');
            localStorage.removeItem('cfg_vfinal_bg_type');
            location.reload();
        }
    }

    function toggleEdit() { 
        const isEdit = document.body.classList.toggle('edit-mode'); 
        const btn = document.getElementById('edit-toggle-btn');
        
        if (btn) {
            btn.innerText = isEdit ? "âœ… å®Œæˆ" : "âš™ï¸ ç®¡ç†"; 
        }
        
        const historyArea = document.getElementById('search-history-area');
        if (historyArea) {
            historyArea.style.zIndex = isEdit ? "9999" : "";
            historyArea.style.position = isEdit ? "relative" : "";
        }
        
        renderHistory(); 
    }

    function updateUI() { 
        const engineVal = document.getElementById('engine').value;
        const e = engines[engineVal]; 
        const logoEl = document.getElementById('logo');
        
        if(e && logoEl) {
            if (e.logoIcon) {
                logoEl.innerHTML = `<img src="${e.logoIcon}" style="height:110px; vertical-align:middle;">`;
            } else {
                logoEl.innerText = e.name;
            }
            logoEl.style.color = e.color;
        }
    }

    function smartOpen(url, event) {
        if (event) {
            event.preventDefault();
            event.stopPropagation();
        }
        
        if (document.body.classList.contains('edit-mode')) {
            return; 
        }
        
        const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
        if (isMobile) {
            window.location.href = url;
        } else {
            window.open(url, '_blank');
        }
    }

    function renderHistory() {
        const hist = JSON.parse(localStorage.getItem('cfg_vfinal_hist')) || [];
        const container = document.getElementById('search-history-area');
        const listContainer = document.getElementById('history-list');
        
        if (!container || !listContainer) return;

        container.style.display = 'block';
        const isEditMode = document.body.classList.contains('edit-mode');

        if (hist.length === 0) {
            listContainer.innerHTML = '<span style="color: #888; font-size: 0.85em; padding: 5px;">æš‚æ— æœç´¢è®°å½•</span>';
        } else {
            listContainer.style.display = 'flex';
            listContainer.style.flexWrap = 'wrap';
            listContainer.style.gap = '12px';

            listContainer.innerHTML = hist.map((item, index) => {
                // æˆªæ–­å†å²è®°å½•æ–‡å­—
                const truncatedName = truncateText(item.name);
                return `
                <div class="history-item" style="position: relative; display: flex; align-items: center; background: rgba(255,255,255,0.08); padding: 8px 16px 8px 10px; border-radius: 20px; max-width: 100%;">
                    <div style="position: relative; width: 32px; height: 32px; flex-shrink: 0; display: flex; align-items: center; justify-content: center;">
                        <div class="history-click-zone" onclick="fillAndSearch('${item.name.replace(/'/g, "\\'")}')" style="cursor: pointer; display: flex; align-items: center; justify-content: center;">
                            <div class="history-icon-circle" style="display: flex; align-items: center; justify-content: center; width: 32px; height: 32px; border-radius: 50%; background: rgba(255,255,255,0.15); font-size: 16px;">
                                ğŸ•’
                            </div>
                        </div>
                        ${isEditMode ? `
                        <div onclick="deleteSingleHistory(${index}, event)" 
                             style="position: absolute; top: -6px; right: -6px; background: #ff4d4d; color: white; border-radius: 50%; width: 18px; height: 18px; display: flex; align-items: center; justify-content: center; font-size: 10px; cursor: pointer; z-index: 102; border: 1.5px solid #222;">
                            âœ•
                        </div>
                        <div onclick="pinToSites('${item.name.replace(/'/g, "\\'")}', event)" 
                             style="position: absolute; top: -6px; left: -6px; background: #2ecc71; color: white; border-radius: 50%; width: 18px; height: 18px; display: flex; align-items: center; justify-content: center; font-size: 10px; cursor: pointer; z-index: 101; border: 1.5px solid #222;">
                            ğŸ“Œ
                        </div>` : ''}
                    </div>
                    <div class="history-text-selectable" 
                         style="margin-left: 12px; font-size: 14px; color: rgba(255,255,255,0.9); cursor: text; white-space: normal; word-break: break-all; line-height: 1.3; user-select: text; -webkit-user-select: text;">
                        ${truncatedName}
                    </div>
                </div>`;
            }).join('');
        }
    }

    function pinToSites(name, event) {
        if (event) event.stopPropagation();
        
        let sites = JSON.parse(localStorage.getItem('cfg_vfinal_sites')) || [];
        if (sites.some(s => s.name === name)) {
            alert("å·²å­˜åœ¨");
            return;
        }
        
        const engineSelect = document.getElementById('engine');
        const type = (engineSelect && engineSelect.value) ? engineSelect.value : Object.keys(engines)[0];
        let targetUrl = "https://www.google.com/search?q=" + encodeURIComponent(name);
        
        if (engines[type]) {
            targetUrl = engines[type].url + encodeURIComponent(name);
        }
        
        sites.push({ name: name, url: targetUrl, icon: "" });
        localStorage.setItem('cfg_vfinal_sites', JSON.stringify(sites));
        render();
        alert("å·²å›ºå®šåˆ°å¿«æ·å¯¼èˆª");
    }

    function deleteSingleHistory(index, event) {
        if (event) event.stopPropagation();
        
        let hist = JSON.parse(localStorage.getItem('cfg_vfinal_hist')) || [];
        hist.splice(index, 1);
        localStorage.setItem('cfg_vfinal_hist', JSON.stringify(hist));
        renderHistory();
    }

    function clearHistory() {
        if (!confirm("ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰è®°å½•å—ï¼Ÿ")) return;
        localStorage.removeItem('cfg_vfinal_hist');
        renderHistory();
    }

    function fillAndSearch(name) {
        const input = document.getElementById('search-input');
        const engineSelect = document.getElementById('engine'); 
        
        if (input) {
            input.value = name;
            const type = (engineSelect && engineSelect.value) ? engineSelect.value : Object.keys(engines)[0];
            const targetUrl = engines[type].url + encodeURIComponent(name);
            
            smartOpen(targetUrl);
            saveSearch(name); 
            renderHistory();
        }
    }

    async function refreshPublicIP() {
        const ipDisplay = document.getElementById('pub-ip');
        if (!ipDisplay) return;
    
        const token = 'e529fa187290a6';
        
        try {
            const resp = await fetch(`https://ipinfo.io/json?token=${token}`);
            
            if (!resp.ok) throw new Error("IPinfo è¯·æ±‚å¤±è´¥");
        
            const data = await resp.json();
            const country = data.country || "æœªçŸ¥å›½å®¶";
            const region = data.region || "";
            const city = data.city || "";
        
            ipDisplay.innerText = `IP: ${data.ip}\nä½ç½®: ${country} ${region} ${city}`.trim();
        
        } catch (e) {
            console.error("IPinfo å¤±è´¥ï¼Œå°è¯•å¤‡ç”¨é“¾è·¯:", e);
            
            try {
                const resp = await fetch('https://api.ipify.org?format=json');
                const data = await resp.json();
                ipDisplay.innerText = `IP: ${data.ip}\nä½ç½®: å¤‡ç”¨é“¾è·¯å·²æ¿€æ´» (æ— ä½ç½®ä¿¡æ¯)`;
            } catch (err) {
                ipDisplay.innerText = "IP: è·å–å¤±è´¥\nä½ç½®: è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥";
            }
        }
    }

    async function getDeviceInfo() {
        const el = document.getElementById('auto-device-info');
        const memoInput = document.getElementById('memo-input');
        if (!el) return;

        const ua = navigator.userAgent;
        const platform = navigator.platform;
        let osDisplay = "OtherOS";

        if (ua.includes("Win")) {
            osDisplay = "Windows";
        } else if (ua.includes("Android")) {
            osDisplay = "Android";
        } else if (ua.includes("iPad") || (platform === "MacIntel" && navigator.maxTouchPoints > 1)) {
            osDisplay = "iPad";
        } else if (ua.includes("Mac")) {
            osDisplay = "Mac";
        } else if (ua.includes("Linux")) {
            osDisplay = "Linux";
        }

        let loadTime = "æµ‹é€Ÿä¸­";
        const nav = performance.getEntriesByType("navigation")[0];

        if (nav) {
            if (nav.loadEventEnd > 0) {
                loadTime = Math.round(nav.loadEventEnd);
            } else if (nav.responseEnd > 0) {
                loadTime = Math.round(nav.responseEnd);
            }
        }

        const renderAll = (batteryStr = window.lastBattery || "") => {
            const wordCount = memoInput ? memoInput.value.length : 0;
            el.textContent =
                `SYST: ${osDisplay}${batteryStr}\n` +
                `â±ï¸å»¶æ—¶ ${loadTime}ms | ğŸ“ ${wordCount}å­—`;
        };

        if (navigator.getBattery) {
            try {
                const battery = await navigator.getBattery();
                const update = () => {
                    window.lastBattery =
                        ` | ${battery.charging ? "âš¡" : "ğŸ”‹"} ${Math.floor(battery.level * 100)}%`;
                    renderAll();
                };
                update();
                battery.onlevelchange = update;
                battery.onchargingchange = update;
            } catch (e) {
                renderAll();
            }
        } else {
            renderAll();
        }

        window.refreshDeviceInfo = renderAll;
    }

    function manageMemo() {
        const memoInput = document.getElementById('memo-input');
        const saveStatus = document.getElementById('save-status');
        const copyBtn = document.getElementById('copy-btn');
        const clearBtn = document.getElementById('clear-btn');
        const resendBtn = document.getElementById('resend-btn');

        const EMAILJS_PUBLIC_KEY = '3P1oxXvgHXRlgdSHu'; 
        const EMAILJS_SERVICE_ID = 'service_erqf5v7';     
        const EMAILJS_TEMPLATE_ID = 'template_9hmy1gr';   
        const TARGET_EMAIL = '7533153@qq.com';

        function formatDateTime() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hour = String(now.getHours()).padStart(2, '0');
            const minute = String(now.getMinutes()).padStart(2, '0');
            const second = String(now.getSeconds()).padStart(2, '0');
            return `${year}å¹´${month}æœˆ${day}æ—¥ ${hour}:${minute}:${second}`;
        }

        async function sendToEmail() {
            const content = memoInput.value.trim();
            if (!content) {
                alert('æš‚æ— å†…å®¹å¯å‘é€ï¼Œè¯·å…ˆè¾“å…¥å¤‡å¿˜å½•å†…å®¹ï¼');
                return;
            }
        
            resendBtn.textContent = 'âœ‰ï¸ å‘é€ä¸­...';
            resendBtn.disabled = true;
            resendBtn.style.cursor = 'not-allowed';
        
            try {
                const response = await fetch('https://api.emailjs.com/api/v1.0/email/send', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        service_id: EMAILJS_SERVICE_ID,
                        template_id: EMAILJS_TEMPLATE_ID,
                        user_id: EMAILJS_PUBLIC_KEY,
                        template_params: {
                            memo_content: content,
                            subject: 'å¤‡å¿˜å½•å†…å®¹å¤‡ä»½',
                            datetime: formatDateTime(),
                            to_email: TARGET_EMAIL
                        }
                    })
                });
            
                const responseText = await response.text();
                if (response.ok && responseText === 'OK') {
                    alert('âœ… å¤‡å¿˜å½•å·²å‘é€åˆ°é‚®ç®±ï¼');
                } else {
                    throw new Error(responseText || `è¯·æ±‚å¤±è´¥ï¼ˆçŠ¶æ€ç ï¼š${response.status}ï¼‰`);
                }
            
            } catch (error) {
                console.error('å‘é€å¤±è´¥è¯¦æƒ…ï¼š', error);
                alert(`âŒ å‘é€å¤±è´¥ï¼š${error.message.substring(0, 100)}`);
            } finally {
                resendBtn.textContent = 'âœ‰ï¸ å‘é€åˆ°é‚®ç®±';
                resendBtn.disabled = false;
                resendBtn.style.cursor = 'pointer';
            }
        }

        if (resendBtn) {
            resendBtn.addEventListener('click', sendToEmail);
        }

        const rawData = localStorage.getItem(STORAGE_KEY);
        if (rawData && memoInput) {
            try {
                const data = JSON.parse(rawData);
                memoInput.value = (typeof data === 'object' && data.content !== undefined) ? data.content : rawData;
            } catch (e) { 
                memoInput.value = rawData; 
            }
        }

        let timer;
        if (memoInput) {
            memoInput.addEventListener('input', () => {
                if (saveStatus) saveStatus.style.opacity = 1;
                if (window.refreshDeviceInfo) window.refreshDeviceInfo();
                
                clearTimeout(timer);
                timer = setTimeout(() => {
                    const memoObj = {
                        content: memoInput.value,
                        lastModified: new Date().toISOString()
                    };
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(memoObj));
                    
                    if (saveStatus) {
                        setTimeout(() => { 
                            saveStatus.style.opacity = 0; 
                        }, 1500);
                    }
                }, 800);
            });
        }

        if (copyBtn) {
            copyBtn.onclick = () => {
                navigator.clipboard.writeText(memoInput.value).then(() => {
                    const oldText = copyBtn.innerText;
                    copyBtn.innerText = "âœ… å·²å¤åˆ¶";
                    setTimeout(() => { 
                        copyBtn.innerText = oldText; 
                    }, 2000);
                });
            };
        }

        if (clearBtn) {
            clearBtn.onclick = () => {
                if (confirm("ç¡®å®šè¦æ¸…ç©ºå¤‡å¿˜å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚")) {
                    memoInput.value = "";
                    localStorage.removeItem(STORAGE_KEY);
                    if (window.refreshDeviceInfo) window.refreshDeviceInfo();
                }
            };
        }
    }

    // å¯¼å‡ºæ•°æ®
    function exportData() {
        try {
            const data = { 
                sites: localStorage.getItem('cfg_vfinal_sites'), 
                bg: localStorage.getItem('cfg_vfinal_bg'), 
                bgType: localStorage.getItem('cfg_vfinal_bg_type'),
                memo: localStorage.getItem(STORAGE_KEY), 
                history: localStorage.getItem('cfg_vfinal_hist')
            };
            const blob = new Blob([JSON.stringify(data)], {type: 'application/json'});
            const a = document.createElement('a'); 
            a.href = URL.createObjectURL(blob); 
            a.download = `nav_full_backup_${new Date().toISOString().slice(0,10)}.json`; 
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(a.href);
        } catch (e) {
            alert("å¤‡ä»½å¤±è´¥ï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨æƒé™");
        }
    }

    // å¯¼å…¥æ•°æ®
    function importData(e) {
        const file = e.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = function() {
            try {
                const data = JSON.parse(reader.result);
                if(data.sites) localStorage.setItem('cfg_vfinal_sites', data.sites); 
                if(data.bg) localStorage.setItem('cfg_vfinal_bg', data.bg); 
                if(data.bgType) localStorage.setItem('cfg_vfinal_bg_type', data.bgType);
                if(data.history) localStorage.setItem('cfg_vfinal_hist', data.history); 
                if(data.memo) {
                    if (data.memo.includes('"content":')) {
                        localStorage.setItem(STORAGE_KEY, data.memo); 
                    } else {
                        const wrapMemo = {
                            content: data.memo,
                            lastModified: new Date().toISOString()
                        };
                        localStorage.setItem(STORAGE_KEY, JSON.stringify(wrapMemo));
                    }
                }
                alert("âœ… æ‰€æœ‰é…ç½®åŒæ­¥æˆåŠŸï¼");
                location.reload();
            } catch(err) { 
                alert("âŒ å¯¼å…¥å¤±è´¥ï¼šæ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®"); 
            }
        };
        reader.readAsText(file);
    }

    // æ¸²æŸ“å¯¼èˆªç«™ç‚¹ï¼ˆæ ¸å¿ƒä¿®å¤ï¼šJSæˆªæ–­æ–‡å­—ï¼‰
    function render() {
        const fixedSites = [
            { id: 1001, name: "Gemini", url: "https://gemini.google.com", remark: "Google å®˜æ–¹ AI åŠ©æ‰‹" },
            { id: 1002, name: "MSCopilot", url: "https://copilot.microsoft.com", remark: "å¾®è½¯ Copilotï¼ˆç½‘é¡µç‰ˆï¼‰" },
            { id: 1003, name: "ChatGPT", url: "https://chatgpt.com", remark: "OpenAI å®˜æ–¹ ChatGPT" },
            { id: 1004, name: "GHCopilot", url: "https://copilot.github.com", remark: "GitHub Copilot äº§å“ä¸»é¡µ" },
            { id: 1005, name: "YouTuBe", url: "https://www.youtube.com", remark: "å…¨çƒæœ€å¤§è§†é¢‘å¹³å° / æŠ€æœ¯ & å¨±ä¹" },
            { id: 1006, name: "YouKu", url: "https://www.youku.com", remark: "å›½å†…è§†é¢‘å¹³å°" },
            { id: 1007, name: "Github", url: "https://www.github.com", remark: "ä»£ç æ‰˜ç®¡ / å¼€æºé¡¹ç›®å¹³å°" },
            { id: 1008, name: "BiliBili", url: "https://www.bilibili.com", remark: "å›½å†…æŠ€æœ¯ / äºŒæ¬¡å…ƒè§†é¢‘ç¤¾åŒº" },
            { id: 1011, name: "MSUser", url: "https://login.live.com", remark: "å¾®è½¯è´¦å·ç»Ÿä¸€ç™»å½•å…¥å£" },
            { id: 1012, name: "Onenote", url: "https://www.onenote.com", remark: "å¾®è½¯ OneNote åœ¨çº¿ç‰ˆ" },
            { id: 1013, name: "Google.HK", url: "https://www.google.com.hk", remark: "Google æœç´¢ï¼ˆé¦™æ¸¯èŠ‚ç‚¹ï¼‰" },
            { id: 1014, name: "Docker", url: "https://www.docker.com/", remark: "å®¹å™¨æŠ€æœ¯å®˜æ–¹ç«™ç‚¹" },
            { id: 1015, name: "IP138", url: "https://www.ip138.com/", remark: "å›½å†… IP / å½’å±åœ°æŸ¥è¯¢" },
            { id: 1016, name: "IP.sb", url: "https://ip.sb/", remark: "å…¬ç½‘ IP / ASN æŸ¥è¯¢" },
            { id: 1017, name: "Gitee", url: "https://gitee.com/", remark: "å›½å†…ä»£ç æ‰˜ç®¡å¹³å°" },
            { id: 1018, name: "OKX", url: "https://www.okx.com/", remark: "åŠ å¯†è´§å¸äº¤æ˜“å¹³å°" },
            { id: 1019, name: "Web3_OKX", url: "https://web3.okx.com/", remark: "OKX Web3 é’±åŒ…ä¸åº”ç”¨" },
            { id: 1020, name: "å¾®è½¯ç¿»è¯‘", url: "https://cn.bing.com/translator", remark: "Microsoft åœ¨çº¿ç¿»è¯‘" },
            { id: 1021, name: "è°·æ­Œç¿»è¯‘", url: "https://translate.google.com/", remark: "Google åœ¨çº¿ç¿»è¯‘" },
            { id: 1022, name: "Binance", url: "https://binance.com/", remark: "åŠ å¯†è´§å¸äº¤æ˜“å¹³å°" },
            { id: 1023, name: "528btc", url: "https://528btc.com/", remark: "åŒºå—é“¾ / æ•°å­—è´§å¸èµ„è®¯" },
            { id: 1024, name: "Grok", url: "https://x.com/i/grok", remark: "X å¹³å°å†…ç½® AIï¼ˆGrokï¼‰" },
            { id: 1025, name: "x", url: "https://x.com/", remark: "Xï¼ˆåŸ Twitterï¼‰ç¤¾äº¤å¹³å°" },
            { id: 1026, name: "M365Copilot", url: "https://m365.cloud.microsoft/chat", remark: "Microsoft 365 Copilot" },
            { id: 1027, name: "PSå›¾åƒå¤„ç†", url: "https://ps.gaoding.com/#/", remark: "åœ¨çº¿ PS / å›¾ç‰‡ç¼–è¾‘" },
            { id: 1028, name: "å¤¸å…‹ç½‘ç›˜", url: "https://pan.quark.cn/", remark: "å¤¸å…‹äº‘ç›˜ / æ–‡ä»¶å­˜å‚¨" },
            { id: 1029, name: "é˜¿é‡Œäº‘", url: "https://www.aliyun.com/", remark: "é˜¿é‡Œäº‘å®˜æ–¹ç«™ç‚¹" },
            { id: 1030, name: "è…¾è®¯äº‘", url: "https://www.dnspod.com/", remark: "DNSPod / è…¾è®¯äº‘ DNS" },
            { id: 1031, name: "Surfaceæ¢å¤é•œåƒ", url: "https://support.microsoft.com/zh-cn/surface-recovery-image", remark: "Surface å®˜æ–¹ç³»ç»Ÿæ¢å¤é•œåƒ" },
            { id: 1032, name: "æ­£åˆ™è¡¨è¾¾å¼æµ‹è¯•", url: "https://tool.oschina.net/regex", remark: "æ­£åˆ™è¡¨è¾¾å¼åœ¨çº¿æµ‹è¯•" },
            { id: 1033, name: "ç«™é•¿å·¥å…·", url: "https://tool.chinaz.com/", remark: "SEO / åŸŸå / ç½‘ç«™åˆ†æå·¥å…·" },
            { id: 1034, name: "æ¨¡å‹å›¾æ ‡é›†", url: "https://lobehub.com/zh/icons", remark: "AI æ¨¡å‹ / åº”ç”¨å›¾æ ‡èµ„æº" },
            { id: 1035, name: "é˜¿é‡Œé‚®ç®±", url: "https://qiye.aliyun.com", icon: "alimail.webp", remark: "é˜¿é‡Œäº‘ä¼ä¸šé‚®ç®±" },
            { id: 1036, name: "è±†åŒ…", url: "https://doubao.com", remark: "å­—èŠ‚è·³åŠ¨ AI åŠ©æ‰‹" },
            { id: 1037, name: "DeepSeek", url: "https://deepseek.com", remark: "DeepSeek å®˜æ–¹ AI" },
            { id: 1038, name: "Cloudflare", url: "https://www.cloudflare.com", remark: "CDN / DNS / WAF / Zero Trust" },
            { id: 1039, name: "Resend", url: "https://www.resend.com", remark: "å¼€å‘è€…é‚®ä»¶å‘é€æœåŠ¡" },
            { id: 1040, name: "Emailjs", url: "https://www.emailjs.com/", remark: "å‰ç«¯ç›´è¿é‚®ä»¶æœåŠ¡" },
            { id: 1041, name: "Outlook", url: "https://www.outlook.com", remark: "å¾®è½¯ Outlook é‚®ç®±" },
            { id: 1042, name: "QQé‚®ç®±", url: "https://mail.qq.com", remark: "è…¾è®¯ QQ é‚®ç®±" },
            { id: 1043, name: "å›¾ç‰‡è½¬æ¢webp", url: "https://tinypng.com/", remark: "å›¾ç‰‡å‹ç¼© / WebP è½¬æ¢" },
            { id: 1044, name: "å…è´¹å›¾ç‰‡ä¸‹è½½", url: "https://pixabay.com/zh/", remark: "å…è´¹å¯å•†ç”¨å›¾ç‰‡ç´ æ" },
            { id: 1045, name: "ipApi", url: "https://ip-api.com/", remark: "IP / ASN / åœ°ç†ä½ç½® API" },
            { id: 1046, name: "èœé¸Ÿæ•™ç¨‹", url: "https://www.runoob.com/", remark: "ç¼–ç¨‹åŸºç¡€ / å¿«é€Ÿå‚è€ƒ" }
        ];
        
        const localSites = JSON.parse(localStorage.getItem('cfg_vfinal_sites')) || [];
        const sites = [...fixedSites, ...localSites];
        
        document.getElementById('site-list').innerHTML = sites.map(s => {
            const isFixed = s.id >= 1000 && s.id <= 1100;
            const btnHtml = isFixed ? '' : `
                <div class="edit-btns">
                    <button class="btn-sm btn-edit" onclick="openSiteModal(${s.id})">âœ</button>
                    <button class="btn-sm btn-del" onclick="removeData('cfg_vfinal_sites', ${s.id})">âœ•</button>
                </div>`;
            
            // æ ¸å¿ƒï¼šç”¨JSæˆªæ–­æ–‡å­—ä¸º2è¡Œï¼ˆæ¯è¡Œæœ€å¤š12å­—ï¼‰
            const truncatedName = truncateText(s.name);
            
            return `
            <div class="card" data-id="${s.id}" title="${s.remark || ''}">
                ${btnHtml}
                <div class="card-content">
                    <div class="icon-circle" onclick="smartOpen('${s.url}', event)">
                        <img src="${s.icon || 'https://www.google.com/s2/favicons?sz=64&domain='+s.url}">
                    </div>
                    <span class="site-name-text">${truncatedName}</span>
                </div>
            </div>`;
        }).join('');
        
        bindUsageClickEvent();
        applyUsageHighlight();
        
        initSortable();
        
        const hist = JSON.parse(localStorage.getItem('cfg_vfinal_hist')) || [];
        document.getElementById('history-list').innerHTML = hist.map(h => {
            const truncatedName = truncateText(h.name);
            return `
            <div class="card">
                <div class="edit-btns">
                    <button class="btn-sm btn-pin" onclick="pinHistory(${h.id})">ğŸ“Œ</button>
                    <button class="btn-sm btn-del" onclick="removeData('cfg_vfinal_hist', ${h.id})">âœ•</button>
                </div>
                <div class="card-content">
                    <div class="icon-circle" style="background:rgba(255,255,255,0.05)" onclick="smartOpen('${h.url}', event)">ğŸ•’</div>
                    <span class="site-name-text" style="opacity: 0.7; font-size: 11px;">${truncatedName}</span>
                </div>
            </div>`;
        }).join('');
    }

    // åº”ç”¨èƒŒæ™¯
    function applyBg(value, type) {
        const body = document.body;
        if (type === 'img') {
            body.style.background = `#202124 url('${value}') no-repeat center center fixed`;
            body.style.backgroundSize = 'cover';
        } else if (type === 'color') {
            body.style.background = value;
            body.style.backgroundSize = 'auto';
        }
        localStorage.setItem('cfg_vfinal_bg', value);
        localStorage.setItem('cfg_vfinal_bg_type', type);
    }

    // ========== é¡µé¢åˆå§‹åŒ– ==========
    document.addEventListener('DOMContentLoaded', () => {
        getDeviceInfo();
        manageMemo();
        refreshPublicIP();
        
        const bg = localStorage.getItem('cfg_vfinal_bg');
        const type = localStorage.getItem('cfg_vfinal_bg_type');
        if (bg) {
            applyBg(bg, type);
        }
        
        updateUI();
        render();
        renderHistory();
        
        document.addEventListener('keydown', e => {
            if (e.altKey && e.key.toLowerCase() === 's') {
                e.preventDefault();
                const currentEngine = document.getElementById('engine').value;
                let nextIndex = (engineKeys.indexOf(currentEngine) + 1) % engineKeys.length;
                setEngine(engineKeys[nextIndex]);
            }
        });
    });
</script>
</body>

</html>







